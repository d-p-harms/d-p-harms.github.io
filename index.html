<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BART Risk Assessment</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            background-color: #f0f0f0;
            display: flex;
            flex-direction: column;
            align-items: center;
            margin: 0;
            padding: 20px;
            color: #333;
        }
        #container {
            background-color: white;
            border-radius: 10px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
            padding: 20px;
            width: 90%;
            max-width: 800px;
            text-align: center;
        }
        #game-area {
            position: relative;
            height: 400px;
            margin: 20px 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }
        #balloon {
            background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 150"><path d="M50,10 C20,10 10,40 10,70 C10,100 30,130 50,130 C70,130 90,100 90,70 C90,40 80,10 50,10" fill="%230080ff" stroke="black" stroke-width="2"/><path d="M45,130 L55,130 L55,145 L45,145 Z" fill="%23daa520" stroke="black" stroke-width="1"/></svg>');
            background-repeat: no-repeat;
            background-position: center;
            background-size: contain;
            position: relative;
            transition: all 0.1s ease-in-out;
        }
        #pop-image {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 200px;
            height: 200px;
            background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><text x="20" y="60" font-family="Arial" font-size="30" fill="red">POP!</text><path d="M10,10 L90,90 M90,10 L10,90" stroke="red" stroke-width="4"/></svg>');
            background-repeat: no-repeat;
            background-size: contain;
            display: none;
        }
        #message {
            font-size: 1.2em;
            margin: 10px 0;
            min-height: 4em;
        }
        #instructions {
            margin: 15px 0;
            font-size: 0.9em;
            color: #555;
        }
        .button {
            background-color: #4CAF50;
            border: none;
            color: white;
            padding: 12px 24px;
            text-align: center;
            text-decoration: none;
            display: inline-block;
            font-size: 16px;
            margin: 10px 5px;
            cursor: pointer;
            border-radius: 5px;
            transition: background-color 0.3s;
        }
        .button:hover {
            background-color: #45a049;
        }
        .button:disabled {
            background-color: #cccccc;
            cursor: not-allowed;
        }
        #pump-button {
            background-color: #2196F3;
        }
        #pump-button:hover {
            background-color: #0b7dda;
        }
        #cashout-button {
            background-color: #ff9800;
        }
        #cashout-button:hover {
            background-color: #e68a00;
        }
        #next-button, #start-button, #show-results-button {
            background-color: #4CAF50;
        }
        #progress-bar {
            width: 100%;
            background-color: #ddd;
            border-radius: 5px;
            margin: 10px 0;
        }
        #progress {
            width: 0;
            height: 20px;
            background-color: #4CAF50;
            border-radius: 5px;
            text-align: center;
            line-height: 20px;
            color: white;
        }
        .screen {
            display: none;
        }
        #info-form {
            text-align: left;
            margin: 20px 0;
        }
        .form-group {
            margin-bottom: 15px;
        }
        label {
            display: block;
            margin-bottom: 5px;
        }
        input, select {
            width: 100%;
            padding: 8px;
            box-sizing: border-box;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        #results-container {
            text-align: left;
            margin: 20px 0;
        }
        #results-summary {
            font-weight: bold;
            margin-bottom: 20px;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        th, td {
            padding: 8px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }
        th {
            background-color: #f2f2f2;
        }
        .result-highlight {
            font-size: 1.2em;
            color: #2196F3;
        }
        #status-message {
            margin-top: 10px;
            padding: 10px;
            border-radius: 5px;
            display: none;
        }
        .success {
            background-color: #dff0d8;
            color: #3c763d;
        }
        .error {
            background-color: #f2dede;
            color: #a94442;
        }
    </style>
</head>
<body>
    <div id="container">
        <h1>Balloon Analogue Risk Task (BART)</h1>
        
        <!-- Welcome Screen -->
        <div id="welcome-screen" class="screen" style="display: block;">
            <p>Welcome to the Balloon Analogue Risk Task (BART), a measure of risk-taking behavior.</p>
            <p>In this task, you will see a balloon that you can inflate by clicking the "Pump" button. Each pump earns you points, but if you pump too much, the balloon will pop and you'll lose all points for that balloon.</p>
            <p>You can choose to "Collect Points" at any time before the balloon pops.</p>
            <p>You will complete 5 balloons in total.</p>
            
            <div id="info-form">
                <h3>Please enter your information:</h3>
                <div class="form-group">
                    <label for="participant-id">Participant ID:</label>
                    <input type="text" id="participant-id" required>
                </div>
                <div class="form-group">
                    <label for="age">Age:</label>
                    <input type="number" id="age" min="18" max="120" required>
                </div>
                <div class="form-group">
                    <label for="gender">Gender:</label>
                    <select id="gender" required>
                        <option value="">Please select</option>
                        <option value="female">Female</option>
                        <option value="male">Male</option>
                        <option value="other">Other</option>
                        <option value="prefer not to say">Prefer not to say</option>
                    </select>
                </div>
            </div>
            
            <button id="start-button" class="button">Begin Task</button>
        </div>
        
        <!-- Game Screen -->
        <div id="game-screen" class="screen">
            <div id="progress-bar">
                <div id="progress">0%</div>
            </div>
            
            <div id="game-area">
                <div id="balloon"></div>
                <div id="pop-image"></div>
            </div>
            
            <div id="message">Trial 1 of 5</div>
            <div id="points-message">Points for this balloon: 0</div>
            <div id="instructions">Press "Pump" to inflate the balloon or "Collect Points" to bank your current points</div>
            
            <div>
                <button id="pump-button" class="button">Pump</button>
                <button id="cashout-button" class="button">Collect Points</button>
            </div>
        </div>
        
        <!-- Results Screen -->
        <div id="results-screen" class="screen">
            <h2>Task Completed!</h2>
            <p>Thank you for participating in the BART task.</p>
            
            <div id="results-container">
                <div id="results-summary">
                    <p>Your risk aversion score: <span id="risk-score" class="result-highlight">--</span> (0-100)</p>
                    <p>Higher scores indicate more risk-averse behavior.</p>
                </div>
                
                <h3>Trial Results:</h3>
                <table id="results-table">
                    <thead>
                        <tr>
                            <th>Trial</th>
                            <th>Pumps</th>
                            <th>Outcome</th>
                        </tr>
                    </thead>
                    <tbody>
                        <!-- Results will be inserted here -->
                    </tbody>
                </table>
                
                <h3>Risk Metrics:</h3>
                <table id="metrics-table">
                    <tbody>
                        <tr>
                            <td>Average pumps (all trials):</td>
                            <td id="avg-pumps-all">--</td>
                        </tr>
                        <tr>
                            <td>Average pumps (unexploded balloons):</td>
                            <td id="avg-pumps-unexploded">--</td>
                        </tr>
                        <tr>
                            <td>Number of explosions:</td>
                            <td id="num-explosions">--</td>
                        </tr>
                        <tr>
                            <td>Proportion of balloons exploded:</td>
                            <td id="prop-explosions">--</td>
                        </tr>
                    </tbody>
                </table>
            </div>
            
            <div id="status-message"></div>
            <button id="restart-button" class="button">Start New Session</button>
        </div>
    </div>

    <script>
        // BART Task Configuration
        const MAX_PUMPS = 128;  // Maximum possible pumps per balloon
        const NUM_TRIALS = 5;   // Total number of balloons
        const POP_PROBABILITIES = [];  // Will be calculated on initialization
        
        // Google Sheets Script URL - REPLACE THIS WITH YOUR SCRIPT URL
        const SCRIPT_URL = 'https://docs.google.com/spreadsheets/d/1ZT5gqVQqNf6HgrDbZpbFbAfPGtOaOGBqMP6eZqF6fmQ/edit?gid=0#gid=0'; 
        
        // Game state
        let currentTrial = 0;
        let currentPumps = 0;
        let pumpsHistory = [];
        let popHistory = [];
        let gameActive = false;
        let participantInfo = {};
        
        // DOM elements
        const welcomeScreen = document.getElementById('welcome-screen');
        const gameScreen = document.getElementById('game-screen');
        const resultsScreen = document.getElementById('results-screen');
        const startButton = document.getElementById('start-button');
        const pumpButton = document.getElementById('pump-button');
        const cashoutButton = document.getElementById('cashout-button');
        const restartButton = document.getElementById('restart-button');
        const balloon = document.getElementById('balloon');
        const popImage = document.getElementById('pop-image');
        const message = document.getElementById('message');
        const pointsMessage = document.getElementById('points-message');
        const progress = document.getElementById('progress');
        const statusMessage = document.getElementById('status-message');
        
        // Calculate pop probabilities for each pump
        function initializePopProbabilities() {
            for (let i = 1; i <= MAX_PUMPS; i++) {
                // Probability increases with each pump
                // For simplicity, we use a linear increase model here
                POP_PROBABILITIES[i] = i / MAX_PUMPS;
            }
        }
        
        // Initialize the game
        function init() {
            initializePopProbabilities();
            
            startButton.addEventListener('click', startGame);
            pumpButton.addEventListener('click', pumpBalloon);
            cashoutButton.addEventListener('click', collectPoints);
            restartButton.addEventListener('click', restart);
        }
        
        // Start the game
        function startGame() {
            // Validate form
            const participantId = document.getElementById('participant-id').value;
            const age = document.getElementById('age').value;
            const gender = document.getElementById('gender').value;
            
            if (!participantId || !age || !gender) {
                alert('Please fill out all fields.');
                return;
            }
            
            // Store participant info
            participantInfo = {
                id: participantId,
                age: age,
                gender: gender,
                date: new Date().toISOString().slice(0, 19).replace('T', ' ')
            };
            
            // Reset game state
            currentTrial = 0;
            currentPumps = 0;
            pumpsHistory = [];
            popHistory = [];
            
            // Show game screen
            welcomeScreen.style.display = 'none';
            gameScreen.style.display = 'block';
            
            // Start first trial
            startTrial();
        }
        
        // Start a new trial
        function startTrial() {
            currentPumps = 0;
            gameActive = true;
            
            // Update UI
            currentTrial++;
            message.textContent = `Trial ${currentTrial} of ${NUM_TRIALS}`;
            pointsMessage.textContent = `Points for this balloon: 0`;
            
            // Reset balloon
            balloon.style.width = '100px';
            balloon.style.height = '150px';
            balloon.style.display = 'block';
            popImage.style.display = 'none';
            
            // Update progress bar
            const progressPercentage = ((currentTrial - 1) / NUM_TRIALS) * 100;
            progress.style.width = `${progressPercentage}%`;
            progress.textContent = `${Math.round(progressPercentage)}%`;
            
            // Enable buttons
            pumpButton.disabled = false;
            cashoutButton.disabled = false;
        }
        
        // Pump the balloon
        function pumpBalloon() {
            if (!gameActive) return;
            
            currentPumps++;
            
            // Check if balloon pops
            const popProbability = POP_PROBABILITIES[currentPumps];
            const randomValue = Math.random();
            
            if (randomValue < popProbability) {
                // Balloon pops
                popBalloon();
            } else {
                // Balloon gets bigger
                const newSize = 100 + (currentPumps * 3);
                balloon.style.width = `${newSize}px`;
                balloon.style.height = `${newSize * 1.5}px`;
                
                // Update points message
                pointsMessage.textContent = `Points for this balloon: ${currentPumps}`;
            }
        }
        
        // Pop the balloon
        function popBalloon() {
            // Update game state
            gameActive = false;
            pumpsHistory.push(currentPumps);
            popHistory.push(true);
            
            // Update UI
            balloon.style.display = 'none';
            popImage.style.display = 'block';
            message.textContent = 'BALLOON POPPED! Points lost.';
            pointsMessage.textContent = 'Points for this balloon: 0';
            
            // Play pop sound effect
            const popSound = new Audio('data:audio/wav;base64,//uQRAAAAWMSLwUIYAAsYkXgoQwAEaYLWfkWgAI0wWs/ItAAAGDgYtAgAyN+QWaAAihwMWm4G8QQRDiMcCBcH3Cc+CDv/7xA4Tvh9Rz/y8QADBwMWgQAZG/ILNAARQ4GLTcDeIIIhxGOBAuD7hOfBB3/94gcJ3w+o5/5eIAIAAAVwWgQAVQ2ORaIQwEMAJiDg95G4nQL7mQVWI6GwRcfsZAcsKkJvxgxEjzFUgfHoSQ9Qq7KNwqHwuB13MA4a1q/DmBrHgPcmjiGoh//EwC5nGPEmS4RcfkVKOhJf+WOgoxJclFz3kgn//dBA+ya1GhurNn8zb//9NNutNuhz31f////9vt///z+IdAEAAAK4LQIAKobHItEIYCGAExBwe8jcToF9zIKrEdDYIuP2MgOWFSE34wYiR5iqQPj0JIeoVdlG4VD4XA67mAcNa1fhzA1jwHuTRxDUQ//iYBczjHiTJcIuPyKlHQkv/LHQUYkuSi57yQT//uggfZNajQ3Vm//Ybnzdk//+h//8/KVdbDuJ3///8//Wvxm1t7lIAaKGYcRH//UCClCxLkzExb3Iap/3Nv10/8Mrrfn1yQj4/Yb+Eg/MhHvvYEeqYuJTmvCr7xyUWD0OLmb9lItk/17Wfj0P9/vbOTt7uIztpJGC//b0WvCn3z2MjFBUxBRKjSJRrxv1emffz//zvfXuWEAAAABD9wvpSgA==');
            popSound.play();
            
            // Disable pump button, enable cashout for next trial
            pumpButton.disabled = true;
            cashoutButton.disabled = true;
            
            // Wait and then move to next trial
            setTimeout(moveToNextTrial, 1500);
        }
        
        // Collect points without popping
        function collectPoints() {
            if (!gameActive || currentPumps === 0) return;
            
            // Update game state
            gameActive = false;
            pumpsHistory.push(currentPumps);
            popHistory.push(false);
            
            // Update UI
            message.textContent = `You collected ${currentPumps} points!`;
            
            // Disable buttons
            pumpButton.disabled = true;
            cashoutButton.disabled = true;
            
            // Wait and then move to next trial
            setTimeout(moveToNextTrial, 1500);
        }
        
        // Move to the next trial or end game
        function moveToNextTrial() {
            if (currentTrial < NUM_TRIALS) {
                startTrial();
            } else {
                showResults();
            }
        }
        
        // Show results screen
        function showResults() {
            // Calculate metrics
            const metrics = calculateRiskMetrics();
            
            // Update UI
            gameScreen.style.display = 'none';
            resultsScreen.style.display = 'block';
            
            // Update results
            document.getElementById('risk-score').textContent = metrics.riskAversionScore.toFixed(1);
            document.getElementById('avg-pumps-all').textContent = metrics.meanPumpsAllTrials.toFixed(2);
            document.getElementById('avg-pumps-unexploded').textContent = metrics.meanAdjustedPumps.toFixed(2);
            document.getElementById('num-explosions').textContent = metrics.numberOfExplosions;
            document.getElementById('prop-explosions').textContent = metrics.proportionExploded.toFixed(2);
            
            // Populate results table
            const resultsTable = document.getElementById('results-table').getElementsByTagName('tbody')[0];
            resultsTable.innerHTML = '';
            
            for (let i = 0; i < pumpsHistory.length; i++) {
                const row = resultsTable.insertRow();
                
                const cellTrial = row.insertCell(0);
                const cellPumps = row.insertCell(1);
                const cellOutcome = row.insertCell(2);
                
                cellTrial.textContent = i + 1;
                cellPumps.textContent = pumpsHistory[i];
                cellOutcome.textContent = popHistory[i] ? 'POPPED' : 'COLLECTED';
            }
            
            // Send data to Google Sheets
            sendResultsToGoogleSheets(metrics);
        }
        
        // Calculate risk metrics
        function calculateRiskMetrics() {
            // Calculate average pumps (all trials)
            const meanPumpsAllTrials = pumpsHistory.reduce((sum, pumps) => sum + pumps, 0) / pumpsHistory.length;
            
            // Calculate adjusted pumps (unexploded balloons only)
            const unexplodedPumps = pumpsHistory.filter((pumps, index) => !popHistory[index]);
            const meanAdjustedPumps = unexplodedPumps.length > 0 
                ? unexplodedPumps.reduce((sum, pumps) => sum + pumps, 0) / unexplodedPumps.length 
                : 0;
            
            // Calculate number of explosions
            const numberOfExplosions = popHistory.filter(popped => popped).length;
            
            // Calculate proportion of balloons exploded
            const proportionExploded = numberOfExplosions / popHistory.length;
            
            // Calculate risk aversion score (0-100, higher = more risk averse)
            // This is the inverse of risk-taking behavior
            const riskAversionScore = meanAdjustedPumps > 0 
                ? 100 * (1 - (meanAdjustedPumps / MAX_PUMPS)) 
                : 100;
            
            return {
                meanPumpsAllTrials,
                meanAdjustedPumps,
                numberOfExplosions,
                proportionExploded,
                riskAversionScore
            };
        }
        
        // Send results to Google Sheets
        function sendResultsToGoogleSheets(metrics) {
            // Check if script URL is set
            if (SCRIPT_URL === 'YOUR_GOOGLE_SCRIPT_URL_HERE') {
                showStatus('Google Sheets integration not configured. Contact experiment administrator.', 'error');
                return;
            }
            
            // Prepare data to send
            const formData = new FormData();
            
            // Add participant info
            formData.append('participantId', participantInfo.id);
            formData.append('age', participantInfo.age);
            formData.append('gender', participantInfo.gender);
            formData.append('timestamp', participantInfo.date);
            
            // Add metrics
            formData.append('riskAversionScore', metrics.riskAversionScore.toFixed(2));
            formData.append('meanPumpsAllTrials', metrics.meanPumpsAllTrials.toFixed(2));
            formData.append('meanAdjustedPumps', metrics.meanAdjustedPumps.toFixed(2));
            formData.append('numberOfExplosions', metrics.numberOfExplosions);
            formData.append('proportionExploded', metrics.proportionExploded.toFixed(2));
            
            // Add trial data
            formData.append('numTrials', NUM_TRIALS);
            for (let i = 0; i < pumpsHistory.length; i++) {
                formData.append(`trial${i+1}Pumps`, pumpsHistory[i]);
                formData.append(`trial${i+1}Outcome`, popHistory[i] ? 'POPPED' : 'COLLECTED');
            }
            
            // Send data
            fetch(SCRIPT_URL, {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.result === 'success') {
                    showStatus('Results successfully saved to database!', 'success');
                } else {
                    showStatus('There was an error saving your results. Please inform the experiment administrator.', 'error');
                    console.error('Error:', data);
                }
            })
            .catch(error => {
                showStatus('There was an error saving your results. Please inform the experiment administrator.', 'error');
                console.error('Error:', error);
            });
        }
        
        // Show status message
        function showStatus(message, type) {
            statusMessage.textContent = message;
            statusMessage.className = type;
            statusMessage.style.display = 'block';
        }
        
        // Restart the task
        function restart() {
            resultsScreen.style.display = 'none';
            welcomeScreen.style.display = 'block';
            statusMessage.style.display = 'none';
        }
        
        // Initialize the game when page loads
        window.onload = init;
    </script>
</body>
</html>